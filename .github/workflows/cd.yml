# =============================================================================
# SecureNotes API - CD Pipeline
# =============================================================================
# This pipeline handles deployment to Kubernetes and optional DAST scanning.
# Triggered after CI pipeline completes successfully.
# =============================================================================

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [master, main]
  workflow_dispatch:  # Allows manual trigger
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  IMAGE_NAME: securenotes-api

jobs:
  # ===========================================================================
  # STAGE 1: DEPLOY - Kubernetes Deployment
  # ===========================================================================
  # WHY: Deploys the validated container image to Kubernetes cluster.
  # Uses declarative manifests for reproducible, version-controlled deployments.
  # ===========================================================================
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure Kubernetes context
        run: |
          echo "Kubernetes deployment would be configured here"
          echo "For production, configure your cluster credentials"

      - name: Update image tag in manifests
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest|g" k8s/deployment.yaml

      - name: Display manifests (dry-run)
        run: |
          echo "=== Deployment Manifest ==="
          cat k8s/deployment.yaml
          echo ""
          echo "=== Service Manifest ==="
          cat k8s/service.yaml

      - name: Deployment summary
        run: |
          echo "Deployment manifests validated successfully!"
          echo "Image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "To deploy manually to Minikube:"
          echo "  1. minikube start"
          echo "  2. kubectl apply -f k8s/"
          echo "  3. minikube service securenotes-api"

  # ===========================================================================
  # STAGE 2: VERIFY - Post-Deployment Verification
  # ===========================================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - name: Verification placeholder
        run: |
          echo "Post-deployment verification would run here"
          echo "This would include:"
          echo "  - Health check against deployed service"
          echo "  - Smoke tests for critical endpoints"
          echo "  - Integration tests if applicable"

  # ===========================================================================
  # STAGE 3: DAST - Dynamic Application Security Testing (Optional)
  # ===========================================================================
  # WHY: Tests the RUNNING application for security vulnerabilities.
  # Unlike SAST which analyzes code, DAST finds runtime issues like:
  # - Authentication bypasses
  # - Session management flaws
  # - Security misconfigurations
  # ===========================================================================
  dast:
    name: DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: [verify]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: DAST scan placeholder
        run: |
          echo "DAST scanning would run here against deployed application"
          echo ""
          echo "OWASP ZAP Baseline Scan would:"
          echo "  - Spider the application to discover endpoints"
          echo "  - Test for common vulnerabilities"
          echo "  - Generate security report"

      - name: DAST Summary
        run: |
          echo "DAST stage completed"
          echo ""
          echo "For local testing, run:"
          echo "  docker run -t owasp/zap2docker-stable zap-baseline.py -t http://localhost:8080"
